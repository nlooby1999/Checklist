<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consignment Checklist</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-200">

    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <div id="current-mode" class="text-lg font-semibold"></div>
            <div class="flex space-x-2">
                <input id="scan-input" type="text" placeholder="Scan Barcode" class="border p-2 w-64">
                <button id="enter-button" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Enter</button>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center mb-4">
            <div>
                <input id="file-input" type="file" class="bg-gray-100 border p-2 rounded-lg">
            </div>
            <div class="flex space-x-2">
                <button id="download-report-button" class="bg-green-500 text-white px-4 py-2 rounded-lg">Download Report</button>
                <button id="remove-checklist-button" class="bg-red-500 text-white px-4 py-2 rounded-lg">Remove Checklist</button>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex justify-between items-center mb-4">
            <select id="run-filter" class="bg-white border p-2 rounded-lg">
                <option value="all">All Runs</option>
            </select>
            <select id="mode-filter" class="bg-white border p-2 rounded-lg">
                <option value="scan">Scan</option>
                <option value="mark">Mark</option>
                <option value="allied">Allied</option>
            </select>
        </div>

        <!-- Checklist Table -->
        <div class="overflow-x-auto">
            <table id="preview-table" class="table-auto w-full bg-white border rounded-lg">
                <thead>
                    <tr class="bg-gray-300">
                        <th class="px-4 py-2">Run</th>
                        <th class="px-4 py-2">Drop</th>
                        <th class="px-4 py-2">Check</th>
                        <th class="px-4 py-2">Marked</th>
                        <th class="px-4 py-2">Location</th>
                        <th class="px-4 py-2">SO Number</th>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Flatpacks</th>
                        <th class="px-4 py-2">Channel</th>
                        <th class="px-4 py-2">Flooring</th>
                        <th class="px-4 py-2">Description</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Unknown Scan Warning -->
        <div id="unknown-scan" class="hidden mt-4 p-4 bg-red-500 text-white text-center rounded-lg">
            Unknown Scan!
        </div>

        <!-- Run Complete Notification -->
        <div id="run-complete" class="hidden mt-4 p-4 bg-green-500 text-white text-center rounded-lg">
            All products scanned!
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="consignment-summary-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <div id="modal-content" class="text-center">
                <h2 id="modal-so-number" class="text-3xl font-bold mb-4"></h2>
                <p id="modal-box-count" class="text-2xl font-semibold mb-4"></p>
                <div id="modal-other-details" class="text-base"></div>
            </div>
            <button id="close-modal-button" class="mt-6 bg-blue-500 text-white px-4 py-2 rounded-lg">Close</button>
        </div>
    </div>

    <!-- Include the required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const scanInput = document.getElementById("scan-input");
            const enterButton = document.getElementById("enter-button");
            const fileInput = document.getElementById("file-input");
            const downloadReportButton = document.getElementById("download-report-button");
            const removeChecklistButton = document.getElementById("remove-checklist-button");
            const unknownScanDiv = document.getElementById("unknown-scan");
            const runCompleteDiv = document.getElementById("run-complete");
            const previewTable = document.getElementById("preview-table");
            const runFilter = document.getElementById("run-filter");
            const modeFilter = document.getElementById("mode-filter");
            const currentModeDisplay = document.getElementById("current-mode");

            const modal = document.getElementById("consignment-summary-modal");
            const modalSO = document.getElementById("modal-so-number");
            const modalBoxCount = document.getElementById("modal-box-count");
            const modalOtherDetails = document.getElementById("modal-other-details");
            const closeModalButton = document.getElementById("close-modal-button");

            const fullBarcodeLength = 11; // Assuming full barcode length is 11 characters

            let products = [];
            let consignments = {};
            let totalProducts = 0;
            let scannedProducts = 0;
            let previewData = [];
            let allPreviewData = [];
            let runSummaries = [];

            // Load data from local storage
            loadDataFromLocalStorage();

            // Handle file input change
            fileInput.addEventListener("change", handleFileUpload);

            // Handle scan input
            scanInput.addEventListener("input", () => {
                if (scanInput.value.length === fullBarcodeLength) {
                    const scannedCode = scanInput.value.trim();
                    processScanInput(scannedCode);
                    scanInput.value = ""; // Clear the input field
                    scanInput.focus(); // Auto focus back on the search bar
                }
            });

            // Handle Enter button click
            enterButton.addEventListener("click", () => {
                const scannedCode = scanInput.value.trim();
                processScanInput(scannedCode);
                scanInput.value = ""; // Clear the input field
                scanInput.focus(); // Auto focus back on the search bar
            });

            // Handle download report button click
            downloadReportButton.addEventListener("click", () => {
                const isComplete = confirm("Is this complete?");
                if (isComplete) {
                    const reportName = prompt("What should this report be called?", "Report");
                    if (reportName) {
                        downloadReport(reportName);
                        clearChecklistData();
                    }
                }
            });

            // Handle remove checklist button click
            removeChecklistButton.addEventListener("click", () => {
                const confirmRemove = confirm("Are you sure you want to remove the checklist?");
                if (confirmRemove) {
                    clearChecklistData();
                    alert("Checklist has been removed.");
                }
            });

            // Handle mode filter change
            modeFilter.addEventListener("change", () => {
                const selectedMode = modeFilter.value;
                currentModeDisplay.textContent = selectedMode.charAt(0).toUpperCase() + selectedMode.slice(1);
                displayPreviewData(previewData);
            });

            // Handle run filter change
            runFilter.addEventListener("change", filterByRun);

            // Handle closing the modal
            closeModalButton.addEventListener("click", () => {
                modal.classList.add("hidden");
            });

            function processScanInput(scannedCode) {
                if (scannedCode) {
                    let found = false;
                    unknownScanDiv.classList.add("hidden");

                    previewData.forEach((row, index) => {
                        if (row.productNumbers.includes(scannedCode)) {
                            if (modeFilter.value === "scan") {
                                row.scannedNumbers.add(scannedCode);
                                if (row.scannedNumbers.size === row.productNumbers.length) {
                                    const rowElement = document.querySelector(`tr[data-index="${index}"]`);
                                    rowElement.children[2].classList.add("complete");
                                    rowElement.children[3].classList.add("complete");
                                    rowElement.querySelector('.status').innerHTML = '✅';
                                }
                            } else if (modeFilter.value === "mark") {
                                row.markedOff = true;
                                displayPreviewData([row]);
                                showModal(row); // Show the modal with consignment details
                            }
                            found = true;
                            scannedProducts++;
                        }
                    });

                    if (found) {
                        scanInput.classList.add("text-green-500");
                        setTimeout(() => {
                            scanInput.classList.remove("text-green-500");
                        }, 1000);
                        checkRunCompletion();
                        saveDataToLocalStorage();
                    } else {
                        if (modeFilter.value === "mark") {
                            displayPreviewData([]); // Clear the table in Mark mode if the scan is unknown
                        }
                        unknownScanDiv.classList.remove("hidden");
                        setTimeout(() => {
                            unknownScanDiv.classList.add("hidden");
                        }, 3000);
                        scanInput.classList.add("text-red-500");
                        setTimeout(() => {
                            scanInput.classList.remove("text-red-500");
                        }, 1000);
                    }

                    if (scannedProducts === totalProducts) {
                        runCompleteDiv.classList.remove("hidden");
                    }
                }
            }

            function showModal(row) {
                modalSO.textContent = `SO Number: ${row.soNumber}`;
                modalBoxCount.textContent = `Box Count: ${row.flatpack + row.channelBoxCount + row.flooringBoxCount}`;
                modalOtherDetails.innerHTML = `
                    <p>Location: ${row.location}</p>
                    <p>Name: ${row.name}</p>
                    <p>Description: ${row.description}</p>
                `;
                modal.classList.remove("hidden");
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    products = [];
                    consignments = {};
                    totalProducts = 0;
                    scannedProducts = 0;
                    previewData = [];
                    allPreviewData = [];
                    runSummaries = [];
                    runCompleteDiv.classList.add("hidden");

                    const previewTbody = previewTable.querySelector("tbody");
                    previewTbody.innerHTML = ""; // Clear any existing preview data
                    let currentRun = '';
                    let currentRunTotalFlatpacks = 0;
                    let currentRunTotalChannels = 0;
                    let currentRunTotalFlooring = 0;
                    let runSet = new Set();

                    sheetData.forEach((row, index) => {
                        if (row.length < 15 || !row[4]) return; // Skip rows with insufficient data or no SO Number

                        const runLetter = row[0];
                        const dropNumber = row[1];
                        const location = row[2];
                        const soNumber = row[4]; // Updated to column E
                        const name = row[5]; // Updated to column F
                        const flatpack = row[10] || 0; // Column K
                        const channelBoxCount = row[11] || 0; // Column L
                        const flooringBoxCount = row[12] || 0; // Column M
                        const description = row[14];
                        const totalCount = flatpack + channelBoxCount + flooringBoxCount;
                        const productNumbers = [];
                        let suffix = 1;

                        for (let i = 0; i < flatpack; i++) {
                            const productNumber = `${soNumber}${String(suffix++).padStart(3, '0')}`;
                            products.push(productNumber);
                            productNumbers.push(productNumber);
                        }

                        for (let i = 0; i < channelBoxCount; i++) {
                            const productNumber = `${soNumber}${String(suffix++).padStart(3, '0')}`;
                            products.push(productNumber);
                            productNumbers.push(productNumber);
                        }

                        for (let i = 0; i < flooringBoxCount; i++) {
                            const productNumber = `${soNumber}${String(suffix++).padStart(3, '0')}`;
                            products.push(productNumber);
                            productNumbers.push(productNumber);
                        }

                        const consignmentKey = `${runLetter}${dropNumber}${soNumber}`;
                        consignments[consignmentKey] = {
                            products: productNumbers,
                            checked: 0,
                            total: totalCount,
                            flatpack,
                            channelBoxCount,
                            flooringBoxCount
                        };

                        totalProducts += totalCount;

                        const rowData = {
                            runLetter,
                            dropNumber,
                            location,
                            soNumber,
                            name,
                            flatpack,
                            channelBoxCount,
                            flooringBoxCount,
                            description,
                            productNumbers,
                            scannedNumbers: new Set(),
                            markedOff: false
                        };

                        previewData.push(rowData);
                        allPreviewData.push(rowData);
                        runSet.add(runLetter);

                        if (currentRun && currentRun !== runLetter) {
                            runSummaries.push({
                                runLetter: currentRun,
                                flatpacks: currentRunTotalFlatpacks,
                                channels: currentRunTotalChannels,
                                flooring: currentRunTotalFlooring,
                                pallets: (currentRunTotalFlatpacks + currentRunTotalChannels + currentRunTotalFlooring) * 2
                            });

                            const summaryRow = document.createElement("tr");
                            summaryRow.classList.add("run-summary");
                            summaryRow.innerHTML = `
                                <td colspan="11"><strong>Run ${currentRun}</strong> - Flatpacks: ${currentRunTotalFlatpacks}, Channels: ${currentRunTotalChannels}, Flooring: ${currentRunTotalFlooring}</td>
                            `;
                            previewTbody.appendChild(summaryRow);
                            currentRunTotalFlatpacks = 0;
                            currentRunTotalChannels = 0;
                            currentRunTotalFlooring = 0;
                        }

                        currentRun = runLetter;

                        if (flatpack > 0) currentRunTotalFlatpacks += flatpack;
                        if (channelBoxCount > 0) currentRunTotalChannels += channelBoxCount;
                        if (flooringBoxCount > 0) currentRunTotalFlooring += flooringBoxCount;

                        const rowElement = document.createElement("tr");
                        rowElement.setAttribute('data-index', index);
                        rowElement.innerHTML = `
                            <td class="run-letter">${runLetter}</td>
                            <td>${dropNumber}</td>
                            <td class="status"></td>
                            <td class="marked-off-status"></td>
                            <td>${location}</td>
                            <td>${soNumber}</td>
                            <td>${name}</td>
                            <td>${flatpack}</td>
                            <td>${channelBoxCount}</td>
                            <td>${flooringBoxCount}</td>
                            <td>${description}</td>
                        `;
                        previewTbody.appendChild(rowElement);
                    });

                    // Add final summary row for the last run
                    if (currentRun) {
                        runSummaries.push({
                            runLetter: currentRun,
                            flatpacks: currentRunTotalFlatpacks,
                            channels: currentRunTotalChannels,
                            flooring: currentRunTotalFlooring,
                            pallets: (currentRunTotalFlatpacks + currentRunTotalChannels + currentRunTotalFlooring) * 2
                        });

                        const summaryRow = document.createElement("tr");
                        summaryRow.classList.add("run-summary");
                        summaryRow.innerHTML = `
                            <td colspan="11"><strong>Run ${currentRun}</strong> - Flatpacks: ${currentRunTotalFlatpacks}, Channels: ${currentRunTotalChannels}, Flooring: ${currentRunTotalFlooring}</td>
                        `;
                        previewTbody.appendChild(summaryRow);
                    }

                    // Populate the run filter dropdown
                    runFilter.innerHTML = '<option value="all">All Runs</option>'; // Reset options and include 'All Runs'
                    runSet.forEach(run => {
                        const option = document.createElement("option");
                        option.value = run;
                        option.textContent = run;
                        runFilter.appendChild(option);
                    });

                    // Save data to local storage
                    saveDataToLocalStorage();

                    // Display preview data
                    displayPreviewData(previewData);
                };

                reader.readAsArrayBuffer(file);
            }

            function filterByRun() {
                const selectedRun = runFilter.value;
                if (selectedRun === "all") {
                    displayPreviewData(allPreviewData);
                } else {
                    const filteredData = allPreviewData.filter(row => row.runLetter === selectedRun);
                    displayPreviewData(filteredData);
                }
            }

            function checkRunCompletion() {
                const runLetters = [...new Set(previewData.map(row => row.runLetter))];
                runLetters.forEach(runLetter => {
                    const runRows = previewData.filter(row => row.runLetter === runLetter);
                    const allScanned = runRows.every(row => row.scannedNumbers.size === row.productNumbers.length);
                    if (allScanned) {
                        document.querySelectorAll(`.run-letter`).forEach(element => {
                            if (element.textContent === runLetter) {
                                element.classList.add("complete");
                            }
                        });
                    }
                });

                updateSummary();
            }

            function updateSummary() {
                const summaryRows = document.querySelectorAll('.run-summary');
                summaryRows.forEach(row => row.remove());

                const previewTbody = document.querySelector('#preview-table tbody');
                let currentRun = '';
                let currentRunTotalFlatpacks = 0;
                let currentRunTotalChannels = 0;
                let currentRunTotalFlooring = 0;

                previewData.forEach((row, index) => {
                    const runLetter = row.runLetter;

                    if (currentRun && currentRun !== runLetter) {
                        runSummaries.push({
                            runLetter: currentRun,
                            flatpacks: currentRunTotalFlatpacks,
                            channels: currentRunTotalChannels,
                            flooring: currentRunTotalFlooring,
                            pallets: (currentRunTotalFlatpacks + currentRunTotalChannels + currentRunTotalFlooring) * 2
                        });

                        const summaryRow = document.createElement("tr");
                        summaryRow.classList.add("run-summary");
                        summaryRow.innerHTML = `
                            <td colspan="11"><strong>Run ${currentRun}</strong> - Flatpacks: ${currentRunTotalFlatpacks}, Channels: ${currentRunTotalChannels}, Flooring: ${currentRunTotalFlooring}</td>
                        `;
                        previewTbody.appendChild(summaryRow);
                        currentRunTotalFlatpacks = 0;
                        currentRunTotalChannels = 0;
                        currentRunTotalFlooring = 0;
                    }

                    currentRun = runLetter;

                    if (row.scannedNumbers.size === row.productNumbers.length) {
                        currentRunTotalFlatpacks += row.flatpack;
                        currentRunTotalChannels += row.channelBoxCount;
                        currentRunTotalFlooring += row.flooringBoxCount;
                    }
                });

                if (currentRun) {
                    runSummaries.push({
                        runLetter: currentRun,
                        flatpacks: currentRunTotalFlatpacks,
                        channels: currentRunTotalChannels,
                        flooring: currentRunTotalFlooring,
                        pallets: (currentRunTotalFlatpacks + currentRunTotalChannels + currentRunTotalFlooring) * 2
                    });

                    const summaryRow = document.createElement("tr");
                    summaryRow.classList.add("run-summary");
                    summaryRow.innerHTML = `
                        <td colspan="11"><strong>Run ${currentRun}</strong> - Flatpacks: ${currentRunTotalFlatpacks}, Channels: ${currentRunTotalChannels}, Flooring: ${currentRunTotalFlooring}</td>
                    `;
                    previewTbody.appendChild(summaryRow);
                }

                // Save updated data to local storage
                saveDataToLocalStorage();
            }

            function displayPreviewData(data) {
                const previewTbody = previewTable.querySelector("tbody");
                previewTbody.innerHTML = ""; // Clear existing preview data

                data.forEach((row, index) => {
                    const rowElement = document.createElement("tr");
                    rowElement.setAttribute('data-index', index);
                    rowElement.innerHTML = `
                        <td class="run-letter">${row.runLetter}</td>
                        <td>${row.dropNumber}</td>
                        <td class="status">${row.scannedNumbers.size === row.productNumbers.length ? '✅' : ''}</td>
                        <td class="marked-off-status">${row.markedOff ? '✅' : ''}</td>
                        <td>${row.location}</td>
                        <td>${row.soNumber}</td>
                        <td>${row.name}</td>
                        <td>${row.flatpack}</td>
                        <td>${row.channelBoxCount}</td>
                        <td>${row.flooringBoxCount}</td>
                        <td>${row.description}</td>
                    `;
                    if (row.scannedNumbers.size === row.productNumbers.length) {
                        rowElement.children[2].classList.add("complete");
                        rowElement.children[3].classList.add("complete");
                    }
                    if (row.markedOff) {
                        rowElement.children[3].classList.add("marked-off");
                    }
                    previewTbody.appendChild(rowElement);
                });
            }

            function downloadReport(reportName) {
                const reportData = previewData.map(row => ({
                    Run: row.runLetter,
                    Drop: row.dropNumber,
                    Check: row.scannedNumbers.size === row.productNumbers.length ? 'Complete' : 'Incomplete',
                    Marked: row.markedOff ? 'true' : 'false',
                    Location: row.location,
                    'SO Number': row.soNumber,
                    Name: row.name,
                    Flatpacks: row.flatpack,
                    Channel: row.channelBoxCount,
                    Flooring: row.flooringBoxCount,
                    Description: row.description
                }));

                const summaryData = runSummaries.map(summary => ({
                    Run: summary.runLetter,
                    Flatpacks: summary.flatpacks,
                    Channels: summary.channels,
                    Flooring: summary.flooring,
                    Pallets: summary.pallets,
                    Notes: summary.notes || ''
                }));

                const now = new Date();
                const timestamp = now.toLocaleString();

                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.sheet_add_aoa(summarySheet, [['Report generated on:', timestamp]], { origin: -1 });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                XLSX.writeFile(workbook, `${reportName}_${now.toISOString().split('T')[0]}.xlsx`);
            }

            function clearChecklistData() {
                // Clear data arrays
                products = [];
                consignments = {};
                totalProducts = 0;
                scannedProducts = 0;
                previewData = [];
                runSummaries = [];
                allPreviewData = [];

                // Clear local storage
                localStorage.removeItem('checklistData');

                // Clear the preview table
                const previewTbody = previewTable.querySelector("tbody");
                previewTbody.innerHTML = "";
            }

            function saveDataToLocalStorage() {
                const data = {
                    products,
                    consignments,
                    totalProducts,
                    scannedProducts,
                    previewData,
                    runSummaries,
                    allPreviewData
                };
                localStorage.setItem('checklistData', JSON.stringify(data));
            }

            function loadDataFromLocalStorage() {
                const data = JSON.parse(localStorage.getItem('checklistData'));
                if (data) {
                    products = data.products;
                    consignments = data.consignments;
                    totalProducts = data.totalProducts;
                    scannedProducts = data.scannedProducts;
                    previewData = data.previewData;
                    runSummaries = data.runSummaries;
                    allPreviewData = data.allPreviewData;

                    const previewTbody = previewTable.querySelector("tbody");
                    previewTbody.innerHTML = ""; // Clear any existing preview data

                    previewData.forEach((row, index) => {
                        const rowElement = document.createElement("tr");
                        rowElement.setAttribute('data-index', index);
                        rowElement.innerHTML = `
                            <td class="run-letter">${row.runLetter}</td>
                            <td>${row.dropNumber}</td>
                            <td class="status">${row.scannedNumbers.size === row.productNumbers.length ? '✅' : ''}</td>
                            <td class="marked-off-status">${row.markedOff ? '✅' : ''}</td>
                            <td>${row.location}</td>
                            <td>${row.soNumber}</td>
                            <td>${row.name}</td>
                            <td>${row.flatpack}</td>
                            <td>${row.channelBoxCount}</td>
                            <td>${row.flooringBoxCount}</td>
                            <td>${row.description}</td>
                        `;
                        if (row.scannedNumbers.size === row.productNumbers.length) {
                            rowElement.children[2].classList.add("complete");
                            rowElement.children[3].classList.add("complete");
                        }
                        if (row.markedOff) {
                            rowElement.children[3].classList.add("marked-off");
                        }
                        previewTbody.appendChild(rowElement);
                    });

                    checkRunCompletion();
                }
            }
        });
    </script>

</body>
</html>
